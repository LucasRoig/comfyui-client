datasource db {
  provider = "sqlite"
}

generator drizzle {
  provider = "pnpm prisma-generator-drizzle-lro"
  output   = "../src/drizzle-generated"
}

model Project {
  id   String @id @default(uuid())
  name String

  InputImage InputImage[]
  templates  Template[]

  @@map("project")
}

model Template {
  id     String  @id @default(uuid())
  name   String
  isRoot Boolean @default(false) @map("is_root")

  parentId String?    @map("parent_id")
  parent   Template?  @relation("TemplateToTemplate", fields: [parentId], references: [id], onDelete: Cascade)
  children Template[] @relation("TemplateToTemplate")

  projectId      String          @map("project_id")
  project        Project         @relation(fields: [projectId], references: [id])
  inputImages    InputImage[]
  templateFields TemplateField[]

  @@unique([projectId, name])
  @@index([name])
  @@map("template")
}

enum FieldKind {
  String
  InputImage
  OutputImage
}

model TemplateField {
  id         String @id @default(uuid())
  fieldId    String @map("field_id")
  fieldLabel String @map("field_label")
  x          Int
  y          Int
  width      Int
  height     Int

  templateId               String                    @map("template_id")
  template                 Template                  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  kind                     FieldKind
  stringField              TemplateStringField?
  templateInputImageFields TemplateInputImageField?
  templateOutputImageField TemplateOutputImageField?

  @@unique([templateId, fieldId])
  @@index([fieldLabel])
  @@map("template_field")
}

model TemplateStringField {
  id String @id @default(uuid())

  fieldId String        @map("field_id")
  field   TemplateField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  parentFieldId     String?               @map("parent_field_id")
  parentField       TemplateStringField?  @relation("child_field", fields: [parentFieldId], references: [id])
  children          TemplateStringField[] @relation("child_field")
  stringFieldValues StringFieldValue[]

  @@unique([fieldId])
  @@map("template_string_field")
}

model StringFieldValue {
  id    String @id @default(uuid())
  value String @default("")

  templateFieldId String              @map("template_field_id")
  templatefield   TemplateStringField @relation(fields: [templateFieldId], references: [id])
  inputImageId    String              @map("input_image_id")
  inputImage      InputImage          @relation(fields: [inputImageId], references: [id])

  @@unique([templateFieldId, inputImageId])
  @@map("string_field_value")
}

model TemplateInputImageField {
  id String @id @default(uuid())

  fieldId String        @map("field_id")
  field   TemplateField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  parentFieldId String?                   @map("parent_field_id")
  parentField   TemplateInputImageField?  @relation("child_field", fields: [parentFieldId], references: [id])
  children      TemplateInputImageField[] @relation("child_field")

  @@unique([fieldId])
  @@map("template_input_image_field")
}

model TemplateOutputImageField {
  id String @id @default(uuid())

  fieldId String        @map("field_id")
  field   TemplateField @relation(fields: [fieldId], references: [id])

  parentFieldId     String?                    @map("parent_field_id")
  parentField       TemplateOutputImageField?  @relation("child_field", fields: [parentFieldId], references: [id])
  children          TemplateOutputImageField[] @relation("child_field")
  outputFieldValues OutputFieldValue[]

  @@unique([fieldId])
  @@map("template_output_image_field")
}

model OutputFieldValue {
  id            String       @id @default(uuid())
  outputImageId String?      @map("output_image_id")
  outputImage   OutputImage? @relation(fields: [outputImageId], references: [id])

  templateFieldId String                   @map("template_field_id")
  templatefield   TemplateOutputImageField @relation(fields: [templateFieldId], references: [id])
  inputImageId    String                   @map("input_image_id")
  inputImage      InputImage               @relation(fields: [inputImageId], references: [id])

  @@unique([templateFieldId, inputImageId])
  @@map("output_field_value")
}

model ImportTask {
  id String @id

  InputImage InputImage[]

  @@map("import_task")
}

model InputImage {
  id               String @id @default(uuid())
  originalFileName String @map("original_file_name")
  originalPath     String @map("original_path")
  type             String

  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id])

  importTaskId String     @map("import_task_id")
  importTask   ImportTask @relation(fields: [importTaskId], references: [id])

  templateId        String             @map("template_id")
  template          Template           @relation(fields: [templateId], references: [id])
  stringFieldValues StringFieldValue[]
  outputFieldValues OutputFieldValue[]

  @@unique([projectId, originalPath])
  @@map("input_image")
}

model ComfyWorkflow {
  id      String   @id @default(uuid())
  json    Json
  prompts Prompt[]

  @@map("comfy_workflow")
}

model Prompt {
  id           String        @id @default(uuid())
  json         Json
  workflowId   String        @map("workflow_id")
  workflow     ComfyWorkflow @relation(fields: [workflowId], references: [id])
  outputImages OutputImage[]

  @@map("prompt")
}

model OutputImage {
  id                String             @id @default(uuid())
  filename          String
  relativePath      String             @map("relative_path")
  promptId          String             @map("prompt_id")
  prompt            Prompt             @relation(fields: [promptId], references: [id])
  nodeId            String             @map("node_id")
  outputFieldValues OutputFieldValue[]

  @@map("output_image")
}
